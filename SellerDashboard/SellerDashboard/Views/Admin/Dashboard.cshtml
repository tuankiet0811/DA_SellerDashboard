@model SellerDashboard.ViewModels.AdminDashboardViewModel
@{
    Layout = null;
}
<!DOCTYPE html>
<html class="light" lang="vi">
<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Admin Dashboard - Velocity Commerce</title>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&amp;display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#13ec6d",
                        "primary-dark": "#0bb854",
                        "background-light": "#f6f8f7",
                        "background-dark": "#102218",
                        "surface-light": "#ffffff",
                        "surface-dark": "#1a2c23",
                        "text-main": "#0d1b13",
                        "text-muted": "#5e7166",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "2xl": "1rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-text-main dark:text-white antialiased transition-colors duration-200">
    <div class="flex min-h-screen flex-col">
        <header class="sticky top-0 z-50 w-full border-b border-[#e7f3ec] dark:border-[#2a4034] bg-background-light/95 dark:bg-background-dark/95 backdrop-blur-sm">
            <div class="mx-auto flex h-16 max-w-7xl items-center justify-between px-4 sm:px-6 lg:px-8 flex-nowrap">
                <div class="flex items-center gap-8">
                    <div class="flex items-center gap-2">
                        <div class="flex size-8 items-center justify-center rounded-lg bg-primary/20 text-primary">
                            <span class="material-symbols-outlined text-2xl">admin_panel_settings</span>
                        </div>
                        <span class="text-xl font-bold tracking-tight text-text-main dark:text-white whitespace-nowrap">Quản Trị</span>
                    </div>
                    <nav class="hidden md:flex items-center gap-4 flex-nowrap">
                        <a id="nav-dashboard" class="flex items-center gap-2 rounded-lg bg-primary/10 px-3 py-2 text-sm font-bold text-primary transition-colors" href="#" onclick="showDashboard(); return false;">
                            <span class="material-symbols-outlined text-[20px]">dashboard</span>
                            Tổng Quan
                        </a>
                        <a id="nav-orders" class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-text-muted hover:text-primary dark:text-gray-400 dark:hover:text-primary transition-colors" href="#" onclick="loadOrderList(); return false;">
                            <span class="material-symbols-outlined text-[20px]">shopping_cart</span>
                            Đơn Hàng
                        </a>
                        <a id="nav-products" class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-text-muted hover:text-primary dark:text-gray-400 dark:hover:text-primary transition-colors" href="#" onclick="loadProductList(); return false;">
                            <span class="material-symbols-outlined text-[20px]">inventory_2</span>
                            Sản Phẩm
                        </a>
                        <a id="nav-promotions" class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-text-muted hover:text-primary dark:text-gray-400 dark:hover:text-primary transition-colors" href="#" onclick="loadPromotionList(); return false;">
                            <span class="material-symbols-outlined text-[20px]">local_offer</span>
                            Khuyến Mãi
                        </a>
                        <a id="nav-analytics" class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-text-muted hover:text-primary dark:text-gray-400 dark:hover:text-primary transition-colors" href="#" onclick="setActiveNav('nav-analytics'); return false;">
                            <span class="material-symbols-outlined text-[20px]">bar_chart</span>
                            Phân Tích
                        </a>
                    </nav>
                </div>
                <div class="flex items-center gap-4">
                    <div class="hidden md:flex items-center gap-2 rounded-lg border border-[#e7f3ec] dark:border-[#2a4034] bg-surface-light dark:bg-surface-dark px-3 py-1.5 whitespace-nowrap">
                        <span class="material-symbols-outlined text-text-muted text-[18px]">calendar_today</span>
                        <input type="date" id="fromDate" class="text-sm bg-transparent border-0 focus:ring-0 text-text-main dark:text-white" />
                        <span class="text-sm text-text-muted">—</span>
                        <input type="date" id="toDate" class="text-sm bg-transparent border-0 focus:ring-0 text-text-main dark:text-white" />
                        <button onclick="refreshDashboard()" class="ml-2 rounded-md bg-primary/10 px-2 py-1 text-xs font-bold text-primary whitespace-nowrap">Áp dụng</button>
                    </div>
                    <div class="flex items-center gap-2">
                        <button class="relative flex size-10 items-center justify-center rounded-lg bg-[#e7f3ec] dark:bg-[#1a2c23] hover:bg-primary/20 transition-colors text-text-main dark:text-white">
                            <span class="material-symbols-outlined text-[20px]">notifications</span>
                            <span class="absolute top-2 right-2 size-2 rounded-full bg-red-500 ring-2 ring-background-light dark:ring-background-dark"></span>
                        </button>
                        <div class="relative group h-full flex items-center">
                            <button class="flex size-10 items-center justify-center rounded-full bg-gradient-to-tr from-primary to-emerald-600 text-white shadow-lg shadow-primary/20">
                                <span class="font-bold text-sm">JD</span>
                            </button>
                            <!-- Dropdown Menu -->
                            <div class="absolute right-0 top-full mt-0 w-48 bg-white dark:bg-[#1a2c23] rounded-lg shadow-xl border border-gray-100 dark:border-[#2a4034] hidden group-hover:block z-50 pt-2">
                                <div class="py-1 bg-white dark:bg-[#1a2c23] rounded-lg">
                                    <form asp-controller="Account" asp-action="Logout" method="post" class="block">
                                        <button type="submit" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20">
                                            Đăng xuất
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        <main class="flex-1 py-8">
            <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
                <div id="dashboard-content">
                <div class="mb-8 flex flex-col justify-between gap-4 sm:flex-row sm:items-center">
                    <div>
                        <h1 class="text-2xl font-bold text-text-main dark:text-white">Tổng Quan Hệ Thống</h1>
                        <p class="text-sm text-text-muted mt-1">Theo dõi hiệu suất cửa hàng và các chỉ số bán hàng.</p>
                    </div>
                    <button class="flex items-center gap-2 rounded-lg bg-primary px-4 py-2 text-sm font-bold text-background-dark shadow-lg shadow-primary/25 hover:bg-primary/90 transition-all">
                        <span class="material-symbols-outlined text-[20px]">download</span>
                        Xuất Báo Cáo
                    </button>
                </div>
                <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-4 mb-8">
                    <div class="rounded-2xl border border-[#e7f3ec] dark:border-[#2a4034] bg-surface-light dark:bg-surface-dark p-6 shadow-sm transition-all hover:shadow-md min-h-[140px]">
                        <div class="flex items-center justify-between">
                            <div class="flex size-12 items-center justify-center rounded-xl bg-green-100 text-green-600 dark:bg-green-900/30 dark:text-green-400">
                                <span class="material-symbols-outlined text-[24px]">payments</span>
                            </div>
                            <span class="flex items-center gap-1 rounded-full bg-green-50 px-2 py-1 text-xs font-bold text-green-600 dark:bg-green-900/20 dark:text-green-400">
                                <span class="material-symbols-outlined text-[14px]">trending_up</span> 12.5%
                            </span>
                        </div>
                        <div class="mt-4">
                            <p class="text-sm font-medium text-text-muted">Tổng Doanh Thu</p>
                            <h3 class="metrics-total-revenue mt-1 text-2xl font-bold text-text-main dark:text-white">@string.Format(System.Globalization.CultureInfo.GetCultureInfo("vi-VN"), "{0:C0}", Model.TotalRevenue)</h3>
                        </div>
                    </div>
                    <div class="rounded-2xl border border-[#e7f3ec] dark:border-[#2a4034] bg-surface-light dark:bg-surface-dark p-6 shadow-sm transition-all hover:shadow-md min-h-[140px]">
                        <div class="flex items-center justify-between">
                            <div class="flex size-12 items-center justify-center rounded-xl bg-blue-100 text-blue-600 dark:bg-blue-900/30 dark:text-blue-400">
                                <span class="material-symbols-outlined text-[24px]">shopping_bag</span>
                            </div>
                            <span class="flex items-center gap-1 rounded-full bg-green-50 px-2 py-1 text-xs font-bold text-green-600 dark:bg-green-900/20 dark:text-green-400">
                                <span class="material-symbols-outlined text-[14px]">trending_up</span> 5.2%
                            </span>
                        </div>
                        <div class="mt-4">
                            <p class="text-sm font-medium text-text-muted">Tổng Đơn Hàng</p>
                            <h3 class="metrics-total-orders mt-1 text-2xl font-bold text-text-main dark:text-white">@Model.TotalOrders</h3>
                        </div>
                    </div>
                    <div class="rounded-2xl border border-[#e7f3ec] dark:border-[#2a4034] bg-surface-light dark:bg-surface-dark p-6 shadow-sm transition-all hover:shadow-md min-h-[140px]">
                        <div class="flex items-center justify-between">
                            <div class="flex size-12 items-center justify-center rounded-xl bg-purple-100 text-purple-600 dark:bg-purple-900/30 dark:text-purple-400">
                                <span class="material-symbols-outlined text-[24px]">ads_click</span>
                            </div>
                            <span class="flex items-center gap-1 rounded-full bg-red-50 px-2 py-1 text-xs font-bold text-red-600 dark:bg-red-900/20 dark:text-red-400">
                                <span class="material-symbols-outlined text-[14px]">trending_down</span> 0.4%
                            </span>
                        </div>
                        <div class="mt-4">
                            <p class="text-sm font-medium text-text-muted">Tỉ Lệ Chuyển Đổi</p>
                            <h3 class="metrics-conversion-rate mt-1 text-2xl font-bold text-text-main dark:text-white">@Model.ConversionRatePercent.ToString("0.0")%</h3>
                        </div>
                    </div>
                    <div class="rounded-2xl border border-[#e7f3ec] dark:border-[#2a4034] bg-surface-light dark:bg-surface-dark p-6 shadow-sm transition-all hover:shadow-md min-h-[140px]">
                        <div class="flex items-center justify-between">
                            <div class="flex size-12 items-center justify-center rounded-xl bg-orange-100 text-orange-600 dark:bg-orange-900/30 dark:text-orange-400">
                                <span class="material-symbols-outlined text-[24px]">receipt_long</span>
                            </div>
                            <span class="flex items-center gap-1 rounded-full bg-green-50 px-2 py-1 text-xs font-bold text-green-600 dark:bg-green-900/20 dark:text-green-400">
                                <span class="material-symbols-outlined text-[14px]">trending_up</span> 2.1%
                            </span>
                        </div>
                        <div class="mt-4">
                            <p class="text-sm font-medium text-text-muted">Giá Trị Đơn Hàng TB</p>
                            <h3 class="metrics-aov mt-1 text-2xl font-bold text-text-main dark:text-white">@string.Format(System.Globalization.CultureInfo.GetCultureInfo("vi-VN"), "{0:C0}", Model.AverageOrderValue)</h3>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                    <div class="lg:col-span-2 rounded-2xl border border-[#e7f3ec] dark:border-[#2a4034] bg-surface-light dark:bg-surface-dark p-6 shadow-sm h-full">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-lg font-bold text-text-main dark:text-white">Xu Hướng Doanh Thu</h3>
                            <div class="flex gap-2">
                                <button id="btnDaily" class="rounded-md bg-primary/10 px-3 py-1 text-xs font-bold text-primary" onclick="setGranularity('daily')">Theo ngày</button>
                                <button id="btnMonthly" class="rounded-md px-3 py-1 text-xs font-medium text-text-muted hover:bg-gray-100 dark:hover:bg-[#1a2c23]" onclick="setGranularity('monthly')">Theo tháng</button>
                            </div>
                        </div>
                        <div class="relative h-64 w-full pt-4">
                            <div class="absolute inset-0 flex flex-col justify-between text-xs text-text-muted">
                                <div class="border-b border-dashed border-gray-200 dark:border-gray-700 w-full h-0"></div>
                                <div class="border-b border-dashed border-gray-200 dark:border-gray-700 w-full h-0"></div>
                                <div class="border-b border-dashed border-gray-200 dark:border-gray-700 w-full h-0"></div>
                                <div class="border-b border-dashed border-gray-200 dark:border-gray-700 w-full h-0"></div>
                                <div class="border-b border-gray-200 dark:border-gray-700 w-full h-0"></div>
                            </div>
                            <svg id="revenueChart" class="absolute inset-0 h-full w-full" preserveAspectRatio="none" viewBox="0 0 100 100">
                                <defs>
                                    <linearGradient id="gradient" x1="0" x2="0" y1="0" y2="1">
                                        <stop offset="0%" stop-color="#13ec6d" stop-opacity="0.2"></stop>
                                        <stop offset="100%" stop-color="#13ec6d" stop-opacity="0"></stop>
                                    </linearGradient>
                                </defs>
                                <path id="revenueArea" d="M0,100 L100,100 Z" fill="url(#gradient)"></path>
                                <polyline id="revenueLine" class="stroke-primary" fill="none" points="" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></polyline>
                            </svg>
                        </div>
                        <div class="mt-2 flex justify-between text-xs text-text-muted">
                            <span id="x1">Bắt đầu</span>
                            <span id="x2"></span>
                            <span id="x3"></span>
                            <span id="x4"></span>
                            <span id="x5"></span>
                            <span id="x6"></span>
                            <span id="x7">Kết thúc</span>
                        </div>
                    </div>
                    <div class="rounded-2xl border border-[#e7f3ec] dark:border-[#2a4034] bg-surface-light dark:bg-surface-dark p-6 shadow-sm h-full">
                        <h3 class="mb-6 text-lg font-bold text-text-main dark:text-white">Tỉ Lệ Trả Hàng</h3>
                        <div class="flex flex-col items-center justify-center">
                            <div id="returnChart" class="relative size-56 rounded-full" style="background: conic-gradient(#e5e7eb 0% 100%);">
                                <div class="absolute inset-4 rounded-full bg-surface-light dark:bg-surface-dark"></div>
                                <div class="absolute inset-0 flex flex-col items-center justify-center">
                                    <span id="returnPercent" class="text-3xl font-bold text-text-main dark:text-white">0%</span>
                                    <span id="returnLabel" class="text-xs font-medium text-text-muted">Đã trả</span>
                                </div>
                            </div>
                            <div id="returnLegend" class="mt-8 grid w-full grid-cols-2 gap-4"></div>
                        </div>
                    </div>
                </div>
                
                <div class="rounded-2xl border border-[#e7f3ec] dark:border-[#2a4034] bg-surface-light dark:bg-surface-dark p-6 shadow-sm">
                    <div class="mb-6 flex items-center justify-between">
                        <h3 class="text-lg font-bold text-text-main dark:text-white">Quản Lý Tồn Kho</h3>
                        <button class="text-sm text-primary font-medium hover:underline" onclick="loadProductList()">Mở danh sách sản phẩm</button>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div class="rounded-xl border border-[#e7f3ec] dark:border-[#2a4034] p-4">
                            <p class="text-sm text-text-muted">Tổng SKU</p>
                            <div class="text-2xl font-bold text-text-main dark:text-white">@Model.TotalSkus</div>
                        </div>
                        <div class="rounded-xl border border-[#e7f3ec] dark:border-[#2a4034] p-4">
                            <p class="text-sm text-text-muted">Số lượng trong kho</p>
                            <div class="text-2xl font-bold text-text-main dark:text-white">@Model.TotalStockUnits</div>
                        </div>
                        <div class="rounded-xl border border-[#e7f3ec] dark:border-[#2a4034] p-4">
                            <p class="text-sm text-text-muted">Hết hàng</p>
                            <div class="text-2xl font-bold text-red-600">@Model.OutOfStockCount</div>
                        </div>
                        <div class="rounded-xl border border-[#e7f3ec] dark:border-[#2a4034] p-4">
                            <p class="text-sm text-text-muted">Sắp hết (≤5)</p>
                            <div class="text-2xl font-bold text-amber-600">@Model.LowStockCount</div>
                        </div>
                    </div>
                    <div class="overflow-x-auto rounded-xl border border-[#e7f3ec] dark:border-[#2a4034]">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-[#f6f8f7] dark:bg-[#102218] text-xs uppercase text-text-main dark:text-white font-semibold">
                                <tr>
                                    <th class="px-4 py-2">Sản phẩm</th>
                                    <th class="px-4 py-2">Tồn kho</th>
                                    <th class="px-4 py-2">Thao tác</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-[#e7f3ec] dark:divide-[#2a4034]">
                                @foreach (var p in Model.LowStockProducts)
                                {
                                    <tr>
                                        <td class="px-4 py-2">
                                            <div class="font-medium text-text-main dark:text-white">@p.Name</div>
                                            <div class="text-xs text-text-muted">@p.Category</div>
                                        </td>
                                        <td class="px-4 py-2 font-bold">@p.StockQuantity</td>
                                        <td class="px-4 py-2">
                                            <div class="flex items-center gap-2">
                                                <input id="qty-@p.Id" type="number" min="0" class="w-24 rounded-md border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-text-main dark:text-white text-sm py-1 px-2" value="@p.StockQuantity" />
                                                <button onclick="updateStock(@p.Id)" class="px-3 py-1 rounded-md bg-primary/10 text-primary text-sm font-bold">Cập nhật</button>
                                            </div>
                                        </td>
                                    </tr>
                                }
                                @if (!Model.LowStockProducts.Any())
                                {
                                    <tr>
                                    <td class="px-4 py-6 text-center text-text-muted" colspan="3">Không có sản phẩm sắp hết hàng</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
                </div>
                <div id="dynamic-content" class="hidden"></div>
            </div>
        </main>
        <footer class="bg-background-light dark:bg-background-dark border-t border-[#e7f3ec] dark:border-[#2a4034] py-8 mt-auto">
            <div class="mx-auto max-w-7xl px-4 flex flex-col md:flex-row items-center justify-between text-center md:text-left gap-4">
                <p class="text-sm text-text-muted">© 2024 Velocity Commerce. Bảng điều khiển quản trị.</p>
                <div class="flex gap-4 text-sm font-medium text-text-muted">
                    <a class="hover:text-primary" href="#">Hỗ trợ</a>
                    <a class="hover:text-primary" href="#">Chính sách bảo mật</a>
                    <a class="hover:text-primary" href="#">Điều khoản sử dụng</a>
                </div>
            </div>
        </footer>
    </div>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
    <script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>
    <script>
        var currentGranularity = 'daily';

        function setGranularity(g) {
            currentGranularity = g;
            $('#btnDaily').toggleClass('bg-primary/10 text-primary font-bold', g === 'daily');
            $('#btnMonthly').toggleClass('bg-primary/10 text-primary font-bold', g === 'monthly');
            refreshDashboard();
        }

        function refreshDashboard() {
            var from = $('#fromDate').val();
            var to = $('#toDate').val();
            $.get('@Url.Action("GetDashboardData", "Admin")', { from: from, to: to, granularity: currentGranularity }, function (data) {
                updateMetrics(data);
                renderRevenueChart(data.series);
                renderReturnPie(data.returnPie);
                renderRegions(data.regions);
            });
        }

        function setActiveNav(id) {
            var activeClasses = 'rounded-lg bg-primary/10 text-primary font-bold';
            var inactiveClasses = 'text-text-muted font-medium';
            $('#nav-dashboard, #nav-orders, #nav-products, #nav-promotions, #nav-analytics')
                .removeClass(activeClasses)
                .addClass(inactiveClasses);
            $('#' + id)
                .addClass(activeClasses)
                .removeClass(inactiveClasses);
        }

        function updateMetrics(data) {
            $('.metrics-total-revenue').text(formatVND(data.totalRevenue));
            $('.metrics-total-orders').text(data.totalOrders);
            $('.metrics-conversion-rate').text((data.conversionRate).toFixed(1) + '%');
            $('.metrics-aov').text(formatVND(data.averageOrderValue));
            $('.metrics-return-requested').text(data.returnRequested);
            $('.metrics-returned').text(data.returned);
            $('.metrics-cancelled').text(data.cancelled);
            $('.metrics-refunded-amount').text(formatVND(data.refundedAmount));
        }

        function renderRevenueChart(series) {
            if (!series || series.length === 0) {
                $('#revenueLine').attr('points', '');
                $('#revenueArea').attr('d', 'M0,100 L100,100 Z');
                return;
            }
            var max = Math.max.apply(null, series.map(function (s) { return s.amount; }));
            var min = 0;
            var n = series.length;
            var points = [];
            if (n === 1) {
                var ySingle = 100 - ((series[0].amount - min) / (max - min || 1)) * 90 - 5;
                points = ['0,' + ySingle.toFixed(2), '50,' + ySingle.toFixed(2), '100,' + ySingle.toFixed(2)];
            } else {
                for (var i = 0; i < n; i++) {
                    var x = (i / (n - 1)) * 100;
                    var y = 100 - ((series[i].amount - min) / (max - min || 1)) * 90 - 5;
                    points.push(x.toFixed(2) + ',' + y.toFixed(2));
                }
            }
            $('#revenueLine').attr('points', points.join(' '));
            var area = 'M0,100 L' + points.join(' L ') + ' L100,100 Z';
            $('#revenueArea').attr('d', area);

            var startLabel = series[0].date;
            var endLabel = series[n - 1].date;
            $('#x1').text(startLabel);
            $('#x7').text(endLabel);
        }

        function renderCategoryChart(categories) {
            var colors = ['#13ec6d', '#0ea5e9', '#f59e0b', '#ef4444', '#8b5cf6', '#22d3ee'];
            var gradientParts = [];
            var acc = 0;
            var legendHtml = '';
            for (var i = 0; i < categories.length; i++) {
                var pct = categories[i].percent;
                var start = acc;
                var end = acc + pct;
                var color = colors[i % colors.length];
                gradientParts.push(color + ' ' + start.toFixed(1) + '% ' + end.toFixed(1) + '%');
                acc = end;
                legendHtml += '<div class="flex items-center gap-2"><span class="size-3 rounded-full" style="background:' + color + '"></span><span class="text-sm text-text-muted">' + categories[i].name + ' - ' + pct.toFixed(1) + '%</span></div>';
            }
            if (gradientParts.length === 0) {
                $('#categoryChart').css('background', 'conic-gradient(#e5e7eb 0% 100%)');
                $('#categoryPercent').text('0%');
                $('#categoryName').text('N/A');
                $('#categoryLegend').html('');
            } else {
                $('#categoryChart').css('background', 'conic-gradient(' + gradientParts.join(', ') + ')');
                $('#categoryPercent').text(categories[0].percent.toFixed(1) + '%');
                $('#categoryName').text(categories[0].name);
                $('#categoryLegend').html(legendHtml);
            }
        }

        function renderReturnPie(pie) {
            var colorsByName = {
                'Returned': '#ef4444',
                'Return Requested': '#0ea5e9',
                'Cancelled': '#f59e0b',
                'Completed': '#13ec6d'
            };
            function translate(name){
                if(name === 'Returned') return 'Đã trả hàng';
                if(name === 'Return Requested') return 'Yêu cầu trả hàng';
                if(name === 'Cancelled') return 'Đã hủy';
                if(name === 'Completed') return 'Hoàn thành';
                return name;
            }
            var gradientParts = [];
            var acc = 0;
            var legendHtml = '';
            for (var i = 0; i < pie.length; i++) {
                var pct = pie[i].percent || 0;
                var start = acc;
                var end = acc + pct;
                var color = colorsByName[pie[i].name] || '#22d3ee';
                gradientParts.push(color + ' ' + start.toFixed(1) + '% ' + end.toFixed(1) + '%');
                acc = end;
                legendHtml += '<div class="flex items-center gap-2"><span class="size-3 rounded-full" style="background:' + color + '"></span><span class="text-sm text-text-muted">' + translate(pie[i].name) + ' - ' + pct.toFixed(1) + '% (' + (pie[i].count || 0) + ')</span></div>';
            }
            if (gradientParts.length === 0) {
                $('#returnChart').css('background', 'conic-gradient(#e5e7eb 0% 100%)');
                $('#returnPercent').text('0%');
                $('#returnLabel').text('Đã trả hàng');
                $('#returnLegend').html('');
            } else {
                $('#returnChart').css('background', 'conic-gradient(' + gradientParts.join(', ') + ')');
                var returnedSlice = pie.find(function(p){ return p.name === 'Returned'; }) || { percent: 0 };
                $('#returnPercent').text((returnedSlice.percent || 0).toFixed(1) + '%');
                $('#returnLabel').text('Đã trả hàng');
                $('#returnLegend').html(legendHtml);
            }
        }

        function renderRegions(regions) {
            var colors = ['#13ec6d', '#0ea5e9', '#f59e0b', '#ef4444'];
            var top = regions.slice(0, 4);
            var barsHtml = '';
            for (var i = 0; i < top.length; i++) {
                var color = colors[i % colors.length];
                var pct = (top[i].percent || 0);
                barsHtml += '<div class="group">' +
                    '<div class="mb-1 flex justify-between text-sm"><span class="font-medium text-text-main dark:text-white">' + top[i].name + '</span><span class="font-bold text-text-main dark:text-white">' + pct.toFixed(1) + '%</span></div>' +
                    '<div class="h-2 w-full rounded-full bg-gray-100 dark:bg-gray-700 overflow-hidden">' +
                    '<div class="h-full rounded-full" style="width:' + pct.toFixed(1) + '%; background:' + color + '"></div>' +
                    '</div>' +
                '</div>';
            }
            $('#regionBars').html(barsHtml);

            var gridHtml = '';
            var cells = 12;
            for (var j = 0; j < cells; j++) {
                var r = regions[j];
                var pct = r ? (r.percent || 0) : 0;
                var alpha = 0.1 + (pct / 100) * 0.9;
                var label = r ? r.name : '';
                gridHtml += '<div class="rounded flex items-center justify-center text-xs font-bold" style="background: rgba(19, 236, 109,' + alpha.toFixed(2) + '); color:' + (alpha > 0.5 ? 'white' : '#0d1b13') + '">' + (label ? label.substring(0, 2).toUpperCase() : '') + '</div>';
            }
            $('#regionHeatmap').html(gridHtml);
        }

        function formatVND(val) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND', maximumFractionDigits: 0 }).format(val);
        }

        $(function(){
            var today = new Date();
            var tomorrow = new Date(today.getTime() + 24 * 60 * 60 * 1000);
            $('#fromDate').val(today.toISOString().slice(0,10));
            $('#toDate').val(tomorrow.toISOString().slice(0,10));
            refreshDashboard();
        });

        function updateStock(id) {
            var qty = parseInt($('#qty-' + id).val(), 10);
            if (isNaN(qty) || qty < 0) qty = 0;
            $.post('@Url.Action("UpdateStock", "Admin")', { id: id, quantity: qty }, function (response) {
                if (response.success) {
                    location.reload();
                } else {
                    alert(response.message || 'Update failed');
                }
            });
        }
        function showDashboard() {
            $('#dashboard-content').removeClass('hidden');
            $('#dynamic-content').addClass('hidden').html('');
            setActiveNav('nav-dashboard');
        }

        function loadProductList() {
            $('#dashboard-content').addClass('hidden');
            $('#dynamic-content').removeClass('hidden').html('<div class="flex justify-center p-10"><div class="animate-spin rounded-full h-10 w-10 border-b-2 border-primary"></div></div>');

            $.get('@Url.Action("ProductList", "Admin")', function (data) {
                $('#dynamic-content').html(data);
            }).fail(function () {
                $('#dynamic-content').html('<p class="text-red-500 p-4">Lỗi tải danh sách sản phẩm.</p>');
            });
            setActiveNav('nav-products');
        }

        function loadOrderList() {
            $('#dashboard-content').addClass('hidden');
            $('#dynamic-content').removeClass('hidden').html('<div class="flex justify-center p-10"><div class="animate-spin rounded-full h-10 w-10 border-b-2 border-primary"></div></div>');

            $.get('@Url.Action("OrderList", "Admin")', function (data) {
                $('#dynamic-content').html(data);
            }).fail(function () {
                $('#dynamic-content').html('<p class="text-red-500 p-4">Lỗi tải danh sách đơn hàng.</p>');
            });
            setActiveNav('nav-orders');
        }

        function updateOrderStatus(id, status) {
            $.post('@Url.Action("UpdateOrderStatus", "Admin")', { id: id, status: status }, function (response) {
                if (response.success) {
                    loadOrderList(); // Reload to see updates
                } else {
                    alert(response.message);
                }
            });
        }

        function approveReturn(id, approve) {
            $.post('@Url.Action("ApproveReturn", "Admin")', { id: id, approve: approve }, function (response) {
                if (response.success) {
                    loadOrderList();
                } else {
                    alert(response.message);
                }
            });
        }

        function loadPromotionList() {
            $('#dashboard-content').addClass('hidden');
            $('#dynamic-content').removeClass('hidden').html('<div class="flex justify-center p-10"><div class="animate-spin rounded-full h-10 w-10 border-b-2 border-primary"></div></div>');

            $.get('@Url.Action("PromotionList", "Admin")', function (data) {
                $('#dynamic-content').html(data);
            }).fail(function () {
                $('#dynamic-content').html('<p class="text-red-500 p-4">Error loading promotions.</p>');
            });
            setActiveNav('nav-promotions');
        }

        function loadCreatePromotion() {
            $.get('@Url.Action("CreatePromotion", "Admin")', function (data) {
                $('#dynamic-content').html(data);
                $.validator.unobtrusive.parse("#createPromotionForm");
            });
        }

        function submitCreatePromotion(e) {
            e.preventDefault();
            var form = $('#createPromotionForm');
            if (form.valid()) {
                $.post(form.attr('action'), form.serialize(), function (response) {
                    if (response.success) {
                        loadPromotionList();
                    } else {
                        $('#dynamic-content').html(response);
                        $.validator.unobtrusive.parse("#createPromotionForm");
                    }
                });
            }
        }

        function loadApplyPromotion(id) {
            $.get('@Url.Action("ApplyPromotion", "Admin")?id=' + id, function (data) {
                $('#dynamic-content').html(data);
            });
        }

        function submitApplyPromotion(e) {
            e.preventDefault();
            var form = $('#applyPromotionForm');
            var formData = form.serialize();
            
            $.post('@Url.Action("ApplyPromotionToProducts", "Admin")', formData, function (response) {
                if (response.success) {
                    alert(response.message);
                    loadPromotionList();
                } else {
                    alert(response.message);
                }
            });
        }

        function loadEditPromotion(id) {
            $.get('@Url.Action("EditPromotion", "Admin")?id=' + id, function (data) {
                $('#dynamic-content').html(data);
                $.validator.unobtrusive.parse("#editPromotionForm");
            }).fail(function () {
                alert('Error loading promotion details.');
            });
        }

        function submitEditPromotion(e, id) {
            e.preventDefault();
            var form = $('#editPromotionForm');
            if (form.valid()) {
                $.post(form.attr('action') + '?id=' + id, form.serialize(), function (response) {
                    if (response.success) {
                        loadPromotionList();
                    } else {
                        $('#dynamic-content').html(response);
                        $.validator.unobtrusive.parse("#editPromotionForm");
                    }
                }).fail(function () {
                    alert('Error updating promotion.');
                });
            }
        }

        function deletePromotion(id) {
            if (confirm('Are you sure you want to delete this promotion? This will remove the promotion from all associated products.')) {
                $.post('@Url.Action("DeletePromotion", "Admin")', { id: id }, function (response) {
                    if (response.success) {
                        loadPromotionList();
                    } else {
                        alert(response.message);
                    }
                }).fail(function () {
                    alert('Error deleting promotion.');
                });
            }
        }

        function loadCreateProduct() {
            $.get('@Url.Action("CreateProduct", "Admin")', function (data) {
                $('#dynamic-content').html(data);
                // Re-parse validation since content is dynamic
                $.validator.unobtrusive.parse("#createProductForm");
            });
        }

        function submitCreateProduct(e) {
            e.preventDefault();
            var form = $('#createProductForm');
            if (form.valid()) {
                var formData = new FormData(form[0]);
                $.ajax({
                    url: form.attr('action'),
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (response) {
                        if (response.success) {
                            loadProductList();
                        } else {
                            // If partial view returned (validation errors)
                            $('#dynamic-content').html(response);
                            $.validator.unobtrusive.parse("#createProductForm");
                        }
                    }
                });
            }
        }

        function loadEditProduct(id) {
             $.get('@Url.Action("EditProduct", "Admin")?id=' + id, function (data) {
                $('#dynamic-content').html(data);
                $.validator.unobtrusive.parse("#editProductForm");
            });
        }

        function submitEditProduct(e) {
            e.preventDefault();
            var form = $('#editProductForm');
            if (form.valid()) {
                var formData = new FormData(form[0]);
                $.ajax({
                    url: form.attr('action'),
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (response) {
                        if (response.success) {
                            loadProductList();
                        } else {
                            $('#dynamic-content').html(response);
                            $.validator.unobtrusive.parse("#editProductForm");
                        }
                    }
                });
            }
        }

        function deleteProduct(id) {
            if (confirm('Are you sure you want to delete this product?')) {
                $.post('@Url.Action("DeleteProduct", "Admin")', { id: id }, function (response) {
                    if (response.success) {
                        loadProductList();
                    } else {
                        alert(response.message);
                    }
                });
            }
        }
    </script>
</body>
</html>